#!/usr/bin/env bar
# -*- mode: sh; sh-shell: bash -*-
# vim: set ft=bash:
# shellcheck shell=bash

### Test Emacs mode detection for Bar.d modules and related files
### This test is informational only and always exits successfully.

function emacs_mode_detection_test ## - Test Emacs mode detection for Bar.d files
{
    # Test if emacs is available
    if ! command -v emacs &>/dev/null; then
        debug "emacs not installed, skipping mode detection test"
        return 0
    fi
    
    # Test each file
    local test_files=(
        "Bar.d/help"
        "Bar.d/cargo"
        "Bar.d/git_lib"
        "Barf"
        "Barf.default"
        "Pleasef.default"
        "bar"
    )
    
    local file test_file mode
    for file in "${test_files[@]}"; do
        test_file="$file"
        
        if [[ ! -f "$test_file" ]]; then
            debug "$file not found"
            continue
        fi
        
        # Use emacs to check mode detection via set-auto-mode
        # Ignore errors since some emacs builds may lack sh-mode support
        mode=$(emacs --batch \
            --eval "(find-file \"$test_file\")" \
            --eval '(message "MODE: %s" (symbol-name major-mode))' \
            2>&1 | grep "^MODE:" | head -1 | sed 's/^MODE: //' || true)
        
        if [[ "$mode" != "sh-mode" && -n "$mode" ]]; then
            debug "$file detected as $mode (expected sh-mode)"
        fi
    done
    
    return 0
}

## Run Emacs mode detection test (informational only)
rule test_emacs_mode_detection: -- emacs_mode_detection_test
