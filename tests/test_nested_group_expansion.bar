#!/usr/bin/env bar
# -*- mode: sh; sh-shell: bash -*-
# vim: set ft=bash:
# shellcheck shell=bash

### Test for nested group and alternative expansion in completion

rule test_nested_group_expansion: 'require contrib/bar_complete'

function test_simple_alternatives ## - Simple alternative expansion using _bar_expand_group_alternatives
{
    local alternatives
    alternatives=$(_bar_expand_group_alternatives "--flag|--other")
    echo "Result: $alternatives"
    if echo "$alternatives" | grep -q "^--flag$" && echo "$alternatives" | grep -q "^--other$"; then
        return 0
    else
        return 1
    fi
}

function test_optional_group ## - Optional group expansion
{
    local result
    result=$(_bar_expand_group_alternatives "[--verbose]")
    echo "Result: $result"
    if [[ "$result" == "--verbose" ]]; then
        return 0
    else
        return 1
    fi
}

function test_complex_nested ## - Complex nested groups with alternatives
{
    local result
    result=$(_bar_expand_group_alternatives "[[--verbose] foo [bar|baz]]")
    echo "Result:"
    echo "$result"
    # Should get --verbose and foo, but NOT bar or baz
    if echo "$result" | grep -q "^--verbose$" && echo "$result" | grep -q "^foo$"; then
        if ! echo "$result" | grep -q "^bar$" && ! echo "$result" | grep -q "^baz$"; then
            return 0
        else
            return 1
        fi
    else
        return 1
    fi
}

function test_alternatives_in_optional ## - Alternatives within optional group
{
    local result
    result=$(_bar_expand_group_alternatives "[foo|bar]")
    echo "Result:"
    echo "$result"
    if echo "$result" | grep -q "^foo$" && echo "$result" | grep -q "^bar$"; then
        return 0
    else
        return 1
    fi
}

function test_required_group ## - Required group
{
    local result
    result=$(_bar_expand_group_alternatives "<file>")
    echo "Result: $result"
    if [[ "$result" == "file" ]]; then
        return 0
    else
        return 1
    fi
}

function test_summary ## - Print summary
{
    echo "Summary"
    echo "The _bar_expand_group_alternatives function now handles:"
    echo "This function is now integrated into the main completion engine"
    echo "and used during completion collection."
    return 0
}

## Run all nested group expansion tests
rule test_nested_group_expansion: -- test_simple_alternatives
rule test_nested_group_expansion: -- test_optional_group
rule test_nested_group_expansion: -- test_complex_nested
rule test_nested_group_expansion: -- test_alternatives_in_optional
rule test_nested_group_expansion: -- test_required_group
rule test_nested_group_expansion: -- test_summary
