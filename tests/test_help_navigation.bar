#!/usr/bin/env bar
# -*- mode: sh; sh-shell: bash -*-
# vim: set ft=bash:
# shellcheck shell=bash

### Validate help navigation behaviour when forcing a pager

function first_line ## - Get first line of command output
{
    local line fd
    exec {fd}< <("$@")
    if IFS= read -r line <&$fd; then
        printf '%s\n' "$line"
        exec {fd}<&-
        return 0
    fi
    exec {fd}<&-
    return 1
}

function first_non_empty_line ## - Get first non-empty line of command output
{
    local line fd
    exec {fd}< <("$@")
    while IFS= read -r line <&$fd; do
        [[ -z "$line" ]] && continue
        printf '%s\n' "$line"
        exec {fd}<&-
        return 0
    done
    exec {fd}<&-
    return 1
}

function test_help_about_jumps ## - Indexed match should jump directly to ABOUT
{
    local about_line
    if ! about_line="$(BAR_FORCE_PAGER=less first_line ./bar --bare help about)"; then
        echo "✗ help about command failed"
        return 1
    fi
    if [[ "$about_line" =~ ^[[:space:]]*ABOUT[[:space:]]*$ ]]; then
        echo "✓ help about jumps to ABOUT"
        return 0
    else
        echo "✗ help about should start at ABOUT (got: $about_line)"
        return 1
    fi
}

function test_help_fallback ## - Unknown query should fall back to full help without failing
{
    local fallback_line
    if ! fallback_line="$(BAR_FORCE_PAGER=less first_non_empty_line ./bar --bare help __does_not_exist)"; then
        echo "✗ help fallback command failed"
        return 1
    fi
    if [[ "$fallback_line" =~ ^[[:space:]]*bar[[:space:]]-- ]]; then
        echo "✓ help fallback prints full help when query is missing"
        return 0
    else
        echo "✗ help fallback should start with header (got: $fallback_line)"
        return 1
    fi
}

function test_help_no_doc_example ## - Example documentation should not be treated as real symbol
{
    local foo_line
    if ! foo_line="$(BAR_FORCE_PAGER=less first_non_empty_line ./bar --bare help foo)"; then
        echo "✗ help foo command failed"
        return 1
    fi
    if [[ "$foo_line" =~ foo ]]; then
        echo "✗ help foo should not jump to documentation example (got: $foo_line)"
        return 1
    else
        echo "✓ help foo does not treat documentation example as symbol"
        return 0
    fi
}

function test_help_partial_function ## - Partial function name should resolve to git_ls_files
{
    local ls_line
    if ! ls_line="$(BAR_FORCE_PAGER=less first_line ./bar --bare help ls_files)"; then
        echo "✗ help ls_files command failed"
        return 1
    fi
    if [[ "$ls_line" =~ ls_files ]]; then
        echo "✓ help ls_files jumps to git_ls_files"
        return 0
    else
        echo "✗ help ls_files should show git_ls_files (got: $ls_line)"
        return 1
    fi
}

function test_help_no_query ## - No query should still succeed under BAR_FORCE_PAGER when piped
{
    local header_line
    if ! header_line="$(BAR_FORCE_PAGER=less first_non_empty_line ./bar --bare help)"; then
        echo "✗ help without query failed"
        return 1
    fi
    if [[ "$header_line" =~ ^[[:space:]]*bar[[:space:]]-- ]]; then
        echo "✓ help without query works under BAR_FORCE_PAGER"
        return 0
    else
        echo "✗ help without query should start with header (got: $header_line)"
        return 1
    fi
}

function test_help_section ## - --section should include the matching section
{
    local section_output
    section_output="$(BAR_FORCE_PAGER=less ./bar --bare help --section ABOUT)" || return 1
    [[ "$section_output" =~ ABOUT ]]
}

## Run all help navigation tests
rule test_help_navigation: -- test_help_about_jumps
rule test_help_navigation: -- test_help_fallback
rule test_help_navigation: -- test_help_no_doc_example
rule test_help_navigation: -- test_help_partial_function
rule test_help_navigation: -- test_help_no_query
rule test_help_navigation: -- test_help_section
