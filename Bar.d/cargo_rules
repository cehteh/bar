#!/bash

rule is_cargo_installed: 'is_command_installed cargo'

function is_cargo_project ## - Checks if 'Cargo.toml' exists
{
    if [[ -f "Cargo.toml" ]]; then
        debug "is cargo project"
        return 0
    else
        trace "is not a cargo project"
        return 1
    fi
}

memofn is_cargo_project

rule lint_sources: is_cargo_project? 'rule_exists? cargo_lint' cargo_lint

rule build_unit_tests: is_cargo_project? cargo_build_unit_tests
rule test_units: is_cargo_project? cargo_test_units

rule build_integration_tests: is_cargo_project? cargo_build_integration_tests
rule test_integrations: is_cargo_project? cargo_test_integrations

rule build_libs: is_cargo_project? 'cargo_build --lib --quiet'
rule build_bins: is_cargo_project? 'cargo build --bins --quiet'
rule build_doc: is_cargo_project? 'cargo_doc --quiet'

rule build_benches: is_cargo_project? 'cargo_build --benches --quiet'
rule build_examples: is_cargo_project? 'cargo_build --examples --quiet'

rule clean: is_cargo_project? 'cargo clean'

# running expensive tests
#rule test_expensive: is_cargo_project? cargo_mutants

# 
# # running benchmarks
# rule bench: build_benches -- info "Running benchmarks..."
# 
# # audit for security issues
# rule audit: -- info "Running dependency audit..."
# 
# # tag last good build
# rule tag: -- info "Tagging last good build..."
# 
# # Activate maintainer curated hooks etc.
# rule activate: -- info "Activating bar..."
# 
# # Usually versioned files should be source and not generated by any rule. Sometimes one wants
# # exceptions from this rule. Like generating a README or CHANGELOG. This can be hooked into
# # this rule. This can be run before committing or as part of the commit check where one checks
# # for git_is_clean after running generate_versioned. When this failed then the user forgotten
# # to update the versioned files.
# rule generate_versioned: -- info "Generating versioned files..."


# #rule build_doc: 'cargo_doc'
# 
# cargo test --bins
# cargo test --doc
# cargo test --examples
# cargo test --lib
# cargo test --tests
# cargo audit --color never -D warnings --stale --quiet
# cargo +nightly miri test
# run_test --timeout 300 cargo msrv --bisect --ignore-lockfile verify
# cargo mutants -j 4 --all-features --colors never
# 
# cargo outdated --color never --exit-code 1
# 
# 
# export RUSTDOCFLAGS="-D rustdoc::broken_intra_doc_links"
# run_test cargo doc
